{% extends 'base.html' %}

{% block title %}Browse Services - Find Local Professionals{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="service-list-header">
    <div class="container">
        <div class="text-center mb-4">
            <h1>Find Services</h1>
            <p>
                Discover trusted professionals in your area
            </p>
        </div>

        <!-- Advanced Search Bar -->
        <div class="service-list-search-card card">
            <div class="card-body">
                <form id="search-form" class="service-list-search-form d-grid">
                    <div class="form-group">
                        <label class="form-label">What service do you need?</label>
                        <div style="position: relative;">
                            <input type="text" name="q" id="search-input" class="form-input" placeholder="e.g., house cleaning, plumbing, tutoring" value="{{ request.GET.q }}">
                            <i class="service-list-search-icon fas fa-search"></i>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <div style="position: relative;">
                            <input type="text" name="location" id="location-input" class="form-input" placeholder="City, Area" value="{{ request.GET.location }}">
                            <i class="service-list-search-icon fas fa-map-marker-alt"></i>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select name="category" id="category-select" class="form-input">
                            <option value="">All Categories</option>
                            <option value="HOME" {% if request.GET.category == 'HOME' %}selected{% endif %}>🏠 Home & Cleaning</option>
                            <option value="FOOD" {% if request.GET.category == 'FOOD' %}selected{% endif %}>🍽️ Food & Catering</option>
                            <option value="BEAUTY" {% if request.GET.category == 'BEAUTY' %}selected{% endif %}>💄 Beauty & Wellness</option>
                            <option value="CREATIVE" {% if request.GET.category == 'CREATIVE' %}selected{% endif %}>🎨 Creative & Talent</option>
                            <option value="RETAIL" {% if request.GET.category == 'RETAIL' %}selected{% endif %}>🛍️ Products & Retail</option>
                            <option value="PROF" {% if request.GET.category == 'PROF' %}selected{% endif %}>💼 Professional Services</option>
                            <option value="TRANSPORT" {% if request.GET.category == 'TRANSPORT' %}selected{% endif %}>🚗 Transport & Delivery</option>
                            <option value="AGENCY" {% if request.GET.category == 'AGENCY' %}selected{% endif %}>🏢 Agency & Business</option>
                            <option value="EDU" {% if request.GET.category == 'EDU' %}selected{% endif %}>📚 Education & Training</option>
                        </select>
                    </div>

                    <button type="submit" class="service-list-search-btn btn btn-primary">
                        <i class="fas fa-search"></i> Search
                    </button>
                </form>

                <!-- Quick Filters -->
                <div class="service-list-quick-filters d-flex gap-2 mt-3">
                    <button class="btn btn-outline btn-sm" onclick="window.location.href='/services/?category=HOME'">🏠 Home Services</button>
                    <button class="btn btn-outline btn-sm" onclick="window.location.href='/services/?category=BEAUTY'">💄 Beauty</button>
                    <button class="btn btn-outline btn-sm" onclick="window.location.href='/services/?category=PROF'">💼 Professional</button>
                    <button class="btn btn-outline btn-sm" onclick="window.location.href='/services/?category=EDU'">📚 Education</button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Filters and Results Section -->
<section class="service-list-main">
    <div class="container">
        <div class="d-flex gap-4">
            <!-- Filters Sidebar -->
            <aside class="service-list-sidebar">
                <div class="service-list-filters-card card">
                    <div class="card-header">
                        <h5><i class="fas fa-filter"></i> Filters</h5>
                    </div>
                    <div class="card-body">
                        <!-- Price Range -->
                        <div class="service-list-filter-group form-group">
                            <label class="service-list-filter-label form-label">💰 Price Range (KES)</label>
                            <div class="service-list-price-inputs d-flex gap-2">
                                <input type="number" name="min_price" id="min-price" class="form-input" placeholder="Min" value="{{ request.GET.min_price }}">
                                <span style="align-self: center; color: var(--text-secondary);">-</span>
                                <input type="number" name="max_price" id="max-price" class="form-input" placeholder="Max" value="{{ request.GET.max_price }}">
                            </div>
                            <div class="service-list-price-range price-slider">
                                <div class="price-range" id="price-range"></div>
                            </div>
                        </div>

                        <!-- Rating Filter -->
                        <div class="service-list-filter-group form-group">
                            <label class="service-list-filter-label form-label">⭐ Minimum Rating</label>
                            <select name="min_rating" id="min-rating" class="form-input">
                                <option value="">Any Rating</option>
                                <option value="4.5" {% if request.GET.min_rating == '4.5' %}selected{% endif %}>⭐⭐⭐⭐⭐ 4.5+ Stars</option>
                                <option value="4" {% if request.GET.min_rating == '4' %}selected{% endif %}>⭐⭐⭐⭐ 4+ Stars</option>
                                <option value="3.5" {% if request.GET.min_rating == '3.5' %}selected{% endif %}>⭐⭐⭐⭐ 3.5+ Stars</option>
                                <option value="3" {% if request.GET.min_rating == '3' %}selected{% endif %}>⭐⭐⭐ 3+ Stars</option>
                            </select>
                        </div>

                        <!-- Availability -->
                        <div class="service-list-filter-group form-group">
                            <label class="service-list-filter-label form-label">🕒 Availability</label>
                            <div class="service-list-availability-labels">
                                <label>
                                    <input type="checkbox" name="availability" value="today" id="available-today" {% if request.GET.availability == 'today' %}checked{% endif %}>
                                    <span>📅 Available Today</span>
                                </label>
                                <label>
                                    <input type="checkbox" name="availability" value="weekend" id="available-weekend" {% if request.GET.availability == 'weekend' %}checked{% endif %}>
                                    <span>🏖️ Available Weekends</span>
                                </label>
                            </div>
                        </div>

                        <!-- Experience -->
                        <div class="service-list-filter-group form-group">
                            <label class="service-list-filter-label form-label">🎓 Experience Level</label>
                            <select name="experience_min" id="experience-select" class="form-input">
                                <option value="">Any Experience</option>
                                <option value="1" {% if request.GET.experience_min == '1' %}selected{% endif %}>🔰 1+ Years</option>
                                <option value="3" {% if request.GET.experience_min == '3' %}selected{% endif %}>👨‍💼 3+ Years</option>
                                <option value="5" {% if request.GET.experience_min == '5' %}selected{% endif %}>🏆 5+ Years</option>
                                <option value="10" {% if request.GET.experience_min == '10' %}selected{% endif %}>👑 10+ Years</option>
                            </select>
                        </div>

                        <!-- Provider Type -->
                        <div class="service-list-filter-group form-group">
                            <label class="service-list-filter-label form-label">👤 Provider Type</label>
                            <select name="provider_type" id="provider-type" class="form-input">
                                <option value="">All Providers</option>
                                <option value="provider" {% if request.GET.provider_type == 'provider' %}selected{% endif %}>👨‍🔧 Individual Provider</option>
                                <option value="business" {% if request.GET.provider_type == 'business' %}selected{% endif %}>🏢 Business</option>
                            </select>
                        </div>

                        <!-- Languages -->
                        <div class="service-list-filter-group form-group">
                            <label class="service-list-filter-label form-label">🗣️ Languages</label>
                            <div class="service-list-languages">
                                <label class="service-list-language-label">
                                    <input type="checkbox" name="languages" value="english">
                                    <span>🇺🇸 English</span>
                                </label>
                                <label class="service-list-language-label">
                                    <input type="checkbox" name="languages" value="swahili">
                                    <span>🇰🇪 Swahili</span>
                                </label>
                                <label class="service-list-language-label">
                                    <input type="checkbox" name="languages" value="french">
                                    <span>🇫🇷 French</span>
                                </label>
                            </div>
                        </div>

                        <div class="service-list-filter-buttons d-flex gap-2">
                            <button type="button" class="btn btn-outline" onclick="applyFilters()">
                                <i class="fas fa-check"></i> Apply
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Results Area -->
            <main class="service-list-main-content">
                <!-- Results Header -->
                <div class="service-list-results-header d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="service-list-results-title">
                            Services {% if request.GET.q %}for "<span>{{ request.GET.q }}</span>"{% endif %}
                        </h2>
                        <p class="service-list-results-count">
                            {% if services %}
                                <i class="fas fa-search"></i>
                                Showing <strong>{{ services|length }}</strong> result{{ services|length|pluralize }}
                            {% else %}
                                <i class="fas fa-exclamation-triangle"></i>
                                No results found
                            {% endif %}
                        </p>
                    </div>

                    <!-- Sort Options -->
                    <div class="d-flex align-items-center gap-2">
                        <label style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600;">📊 Sort by:</label>
                        <select name="sort_by" id="sort-select" class="service-list-sort-select form-input" onchange="changeSort(this.value)">
                            <option value="relevance" {% if request.GET.sort_by == 'relevance' %}selected{% endif %}>🎯 Relevance</option>
                            <option value="rating" {% if request.GET.sort_by == 'rating' %}selected{% endif %}>⭐ Rating</option>
                            <option value="price_low" {% if request.GET.sort_by == 'price_low' %}selected{% endif %}>💰 Price: Low to High</option>
                            <option value="price_high" {% if request.GET.sort_by == 'price_high' %}selected{% endif %}>💎 Price: High to Low</option>
                            <option value="newest" {% if request.GET.sort_by == 'newest' %}selected{% endif %}>🆕 Newest First</option>
                            <option value="popular" {% if request.GET.sort_by == 'popular' %}selected{% endif %}>🔥 Most Popular</option>
                        </select>
                    </div>
                </div>

                <!-- View Toggle -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="service-list-view-toggle d-flex gap-2">
                        <button class="btn btn-outline btn-sm active" id="grid-view" onclick="toggleView('grid')">
                            <i class="fas fa-th"></i> Grid
                        </button>
                        <button class="btn btn-outline btn-sm" id="list-view" onclick="toggleView('list')">
                            <i class="fas fa-list"></i> List
                        </button>
                    </div>

                    <!-- Results per page -->
                    <div class="service-list-per-page d-flex align-items-center gap-2">
                        <label>Show:</label>
                        <select name="per_page" id="per-page" class="form-input" onchange="changePerPage(this.value)">
                            <option value="12" {% if request.GET.per_page == '12' %}selected{% endif %}>12</option>
                            <option value="24" {% if request.GET.per_page == '24' %}selected{% endif %}>24</option>
                            <option value="48" {% if request.GET.per_page == '48' %}selected{% endif %}>48</option>
                        </select>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loading" class="service-list-loading text-center">
                    <div class="loading"></div>
                    <p>Loading services...</p>
                </div>

                <!-- Services Grid -->
                <div id="services-grid" class="service-list-grid">
                    {% for service in services %}
                    <div class="service-list-card service-card">
                        <!-- Service Image -->
                        <div class="service-list-card-image">
                            {% if service.image %}
                                <img src="{{ service.image.url }}" alt="{{ service.name }}">
                                <div class="service-list-card-photo-badge">
                                    📸 Photo
                                </div>
                            {% else %}
                                <div class="service-list-card-no-image">
                                    <i class="fas fa-tools"></i>
                                    <div>No Image</div>
                                </div>
                            {% endif %}

                            <!-- Quick Actions Overlay -->
                            <div class="service-list-card-overlay service-overlay">
                                <div class="service-list-card-overlay-buttons d-flex gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); window.location.href='/services/{{ service.pk }}/'">
                                        <i class="fas fa-eye"></i> Quick View
                                    </button>
                                    <button class="btn btn-outline-light btn-sm" onclick="event.stopPropagation(); window.addToFavorites('{{ service.pk }}')" title="Add to favorites">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="service-list-card-content service-content">
                            <!-- Service Title -->
                            <div class="service-list-card-title service-title">
                                {{ service.name|truncatechars:50 }}
                            </div>

                            <!-- Provider Info -->
                            <div class="service-list-card-provider service-provider">
                                <div class="service-list-card-provider-avatar">
                                    {{ service.provider_name|first|upper }}
                                </div>
                                <div class="service-list-card-provider-info">
                                    <div>
                                        {{ service.provider_name|truncatechars:25 }}
                                    </div>
                                    <div>
                                        {% if service.provider_rating %}
                                            ⭐ {{ service.provider_rating|floatformat:1 }} rating
                                        {% else %}
                                            New provider
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Rating -->
                            <div class="service-list-card-rating service-rating">
                                <div class="service-list-card-rating-stars rating-stars">
                                    {% with ''|center:service.rating|add:'0' as range %}
                                    {% for i in range %}
                                        {% if forloop.counter <= service.rating|floatformat:0 %}
                                            <i class="fas fa-star"></i>
                                        {% elif service.rating|floatformat:1|add:0.5 == forloop.counter|floatformat:1 %}
                                            <i class="fas fa-star-half-alt"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                    {% endwith %}
                                </div>
                                <span>
                                    {{ service.rating|floatformat:1 }} ({{ service.reviews_count }} review{{ service.reviews_count|pluralize }})
                                </span>
                            </div>

                            <!-- Price -->
                            <div class="service-list-card-price service-price">
                                <span>
                                    KES {{ service.price|floatformat:0 }}
                                </span>
                                {% if service.base_price and service.base_price > service.price %}
                                    <span>
                                        KES {{ service.base_price|floatformat:0 }}
                                    </span>
                                    <span>
                                        {% widthratio service.base_price service.price 100|floatformat:0 %}% OFF
                                    </span>
                                {% endif %}
                            </div>

                            <!-- Location & Experience -->
                            <div class="service-list-card-footer d-flex justify-content-between align-items-center mb-3">
                                <div class="service-list-card-location service-location">
                                    <i class="fas fa-map-marker-alt"></i>
                                    {{ service.location|truncatechars:20 }}
                                </div>
                                {% if service.experience_years %}
                                <div class="service-list-card-experience">
                                    🎓 {{ service.experience_years }}y exp
                                </div>
                                {% endif %}
                            </div>

                            <!-- Action Buttons -->
                            <div class="service-list-card-actions d-flex gap-2">
                                <a href="{% url 'services:service-detail' service.pk %}" class="btn btn-primary" onclick="event.stopPropagation();">
                                    <i class="fas fa-info-circle"></i> View Details
                                </a>
                                <button class="btn btn-outline" onclick="event.stopPropagation(); window.location.href='/orders/book/{{ service.pk }}/'" title="Book this service">
                                    <i class="fas fa-calendar-plus"></i>
                                </button>
                                <button class="btn btn-outline" onclick="event.stopPropagation(); window.shareService('{{ service.pk }}')" title="Share this service">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>

                            <!-- Service Tags -->
                            {% if service.has_packages %}
                            <div class="service-list-card-tags">
                                <span class="service-list-card-tag">
                                    📦 Packages Available
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="service-list-empty text-center">
                        <div>
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>No services found</h3>
                        <p>
                            We couldn't find any services matching your criteria. Try adjusting your filters or search for something else.
                        </p>
                        <div class="service-list-empty-actions d-flex gap-3 justify-content-center">
                            <button class="btn btn-primary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                            <a href="{% url 'pages:homepage' %}" class="btn btn-outline">
                                <i class="fas fa-home"></i> Browse All Services
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if services.has_other_pages %}
                <div class="service-list-pagination d-flex justify-content-center mt-5">
                    <nav>
                        <ul class="d-flex gap-2">
                            {% if services.has_previous %}
                                <li><a href="?page={{ services.previous_page_number }}" class="btn btn-outline">Previous</a></li>
                            {% endif %}

                            {% for num in services.paginator.page_range %}
                                {% if services.number == num %}
                                    <li><span class="btn btn-primary">{{ num }}</span></li>
                                {% elif num > services.number|add:'-3' and num < services.number|add:'3' %}
                                    <li><a href="?page={{ num }}" class="btn btn-outline">{{ num }}</a></li>
                                {% endif %}
                            {% endfor %}

                            {% if services.has_next %}
                                <li><a href="?page={{ services.next_page_number }}" class="btn btn-outline">Next</a></li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </main>
        </div>
    </div>
</section>
{% endblock %}
